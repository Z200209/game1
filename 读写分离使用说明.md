# Spring Boot MySQL 主从读写分离配置说明

本项目已配置 MySQL 主从读写分离，实现读写操作的自动分离，提升数据库性能。配置已简化为本地主从库设置，支持 app 和 console 两个模块。

## 配置概述

### 数据源配置 (application-dev.properties)
```properties
# 主数据源配置（写库）
spring.datasource.master.driver-class-name=com.mysql.cj.jdbc.Driver
spring.datasource.master.url=jdbc:mysql://localhost:3306/game?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true
spring.datasource.master.username=root
spring.datasource.master.password=your_password

# 从数据源配置（读库）
spring.datasource.slave.driver-class-name=com.mysql.cj.jdbc.Driver
spring.datasource.slave.url=jdbc:mysql://localhost:3307/game?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true
spring.datasource.slave.username=root
spring.datasource.slave.password=your_password

# Druid连接池配置
spring.datasource.druid.filter.config.enabled=true
spring.datasource.druid.connection-properties=config.decrypt=true;config.decrypt.key=your_key
```

## 核心组件

### 1. 数据源类型枚举 (DataSourceType.java)
```java
public enum DataSourceType {
    MASTER,  // 主库（写操作）
    SLAVE    // 从库（读操作）
}
```

### 2. 数据源上下文持有者 (DataSourceContextHolder.java)
- 使用 ThreadLocal 保存当前线程的数据源类型
- 提供设置、获取和清除数据源的方法

### 3. 动态数据源 (DynamicDataSource.java)
- 继承 AbstractRoutingDataSource
- 根据上下文动态选择数据源

### 4. 数据源配置 (DataSourceConfig.java)
- 配置主从数据源
- 注册到 DynamicDataSource
- 配置 Druid 连接池

### 5. @DataSource 注解
```java
@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
public @interface DataSource {
    DataSourceType value() default DataSourceType.MASTER;
}
```

### 6. AOP 切面 (DataSourceAspect.java)
- 拦截 @DataSource 注解
- 自动切换数据源
- 确保在事务切面之前执行

## 使用方法

### 读操作（使用从库）
```java
@DataSource(DataSourceType.SLAVE)
public User getUserById(BigInteger id) {
    return userMapper.getUserById(id);
}

@DataSource(DataSourceType.SLAVE)
public List<Game> getAllGame(Integer page, Integer pageSize) {
    return gameMapper.getAll(page, pageSize);
}
```

### 写操作（使用主库）
```java
@DataSource(DataSourceType.MASTER)
@Transactional
public int insert(User user) {
    return userMapper.insert(user);
}

@DataSource(DataSourceType.MASTER)
@Transactional
public int update(Game game) {
    return gameMapper.update(game);
}
```

## 已配置的 Service 示例

### UserService
- **读操作（从库）**：getUserById、getUserByPhone、login
- **写操作（主库）**：insert、update、register、updateInfo

### GameService
- **读操作（从库）**：getById、extractById、getAllGame、getAllGameByTypeId、getTotalCount
- **写操作（主库）**：insert、update、delete、edit

## 注意事项

### 1. 事务一致性
- 在同一事务中，建议使用主库确保数据一致性
- @DataSource 注解优先级高于默认配置

### 2. 主从延迟
- 主从同步可能存在延迟
- 对实时性要求高的读操作可考虑使用主库

### 3. 注解优先级
- 方法级注解优先于类级注解
- 显式指定的数据源优先于默认配置

### 4. 线程安全
- 使用 ThreadLocal 确保线程安全
- 每个请求线程独立管理数据源

## 本地主从库配置

### 主库配置 (localhost:3306)
```sql
-- 创建复制用户
CREATE USER 'repl'@'%' IDENTIFIED BY 'password';
GRANT REPLICATION SLAVE ON *.* TO 'repl'@'%';
FLUSH PRIVILEGES;

-- 启用二进制日志
-- 在 my.cnf 中添加：
-- log-bin=mysql-bin
-- server-id=1
```

### 从库配置 (localhost:3307)
```sql
-- 配置主从复制
CHANGE MASTER TO
  MASTER_HOST='localhost',
  MASTER_PORT=3306,
  MASTER_USER='repl',
  MASTER_PASSWORD='password',
  MASTER_AUTO_POSITION=1;

-- 启动从库
START SLAVE;

-- 检查状态
SHOW SLAVE STATUS\G;
```

## 监控和调试

### 1. 日志配置
```properties
# 开启 SQL 日志
logging.level.com.example.module.mapper=DEBUG
logging.level.com.example.module.config.data.DataSourceAspect=DEBUG
```

### 2. Druid 监控
- 访问：http://localhost:8081/druid
- 用户名：admin
- 密码：admin

### 3. 数据源切换日志
- 切面会记录数据源切换信息
- 便于调试和性能分析

## 模块支持

本读写分离配置位于 `module` 模块中，可被以下模块使用：
- **app 模块**：Web 应用模块
- **console 模块**：管理后台模块

两个模块都已配置相同的主从数据源，确保读写分离功能正常工作。

## 性能优势

1. **读写分离**：读操作分散到从库，减轻主库压力
2. **自动切换**：通过注解自动选择合适的数据源
3. **连接池优化**：Druid 连接池提供高性能数据库连接
4. **线程安全**：ThreadLocal 确保多线程环境下的数据源隔离
5. **简化配置**：本地主从库设置，便于开发和测试