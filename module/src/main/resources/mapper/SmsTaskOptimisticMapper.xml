<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.module.mapper.SmsTaskOptimisticMapper">
    
    <!-- 插入短信任务 -->
    <insert id="insert" parameterType="com.example.module.entity.SmsTaskOptimistic" useGeneratedKeys="true" keyProperty="smsTaskOptimistic.id">
        INSERT INTO sms_task_crond (
        <trim suffixOverrides=",">
            <if test="smsTaskOptimistic.phone != null and smsTaskOptimistic.phone != ''">phone,</if>
            <if test="smsTaskOptimistic.templateParam != null and smsTaskOptimistic.templateParam != ''">template_param,</if>
            <if test="smsTaskOptimistic.status != null">status,</if>
            <if test="smsTaskOptimistic.executeTime != null">execute_time,</if>
            <if test="smsTaskOptimistic.createTime != null">create_time,</if>
            <if test="smsTaskOptimistic.updateTime != null">update_time,</if>
            <if test="smsTaskOptimistic.isDeleted != null">is_deleted,</if>
        </trim>
        )
        VALUES (
        <trim suffixOverrides=",">
            <if test="smsTaskOptimistic.phone != null and smsTaskOptimistic.phone != ''">#{smsTaskOptimistic.phone},</if>
            <if test="smsTaskOptimistic.templateParam != null and smsTaskOptimistic.templateParam != ''">#{smsTaskOptimistic.templateParam},</if>
            <if test="smsTaskOptimistic.status != null">#{smsTaskOptimistic.status},</if>
            <if test="smsTaskOptimistic.executeTime != null">#{smsTaskOptimistic.executeTime},</if>
            <if test="smsTaskOptimistic.createTime != null">#{smsTaskOptimistic.createTime},</if>
            <if test="smsTaskOptimistic.updateTime != null">#{smsTaskOptimistic.updateTime},</if>
            <if test="smsTaskOptimistic.isDeleted != null">#{smsTaskOptimistic.isDeleted},</if>
        </trim>
        )
    </insert>
    
    <!-- 乐观锁更新任务状态 -->
    <update id="updateStatusWithOptimisticLock">
        UPDATE sms_task_crond 
        <set>
            <if test="newStatus != null">status = #{newStatus},</if>
            <if test="executeTime != null">execute_time = #{executeTime},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
        </set>
        WHERE id = #{id} AND status = #{oldStatus} AND is_deleted = 0
    </update>
    
    <!-- 更新任务 -->
    <update id="updateWithOptimisticLock">
        UPDATE sms_task_crond 
        <set>
            <if test="phone != null and phone != ''">phone = #{phone},</if>
            <if test="templateParam != null and templateParam != ''">template_param = #{templateParam},</if>
            <if test="status != null">status = #{status},</if>
            <if test="executeTime != null">execute_time = #{executeTime},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
        </set>
        WHERE id = #{id} AND status = #{oldStatus} AND is_deleted = 0
    </update>
    
    <!-- 逻辑删除 -->
    <update id="delete" parameterType="java.math.BigInteger">
        UPDATE sms_task_crond SET is_deleted = 1, update_time = #{time} WHERE id = #{id} AND is_deleted = 0
    </update>
    
    <!-- 查询待执行的任务（按创建时间顺序） -->
    <select id="findPendingTasks" resultType="com.example.module.entity.SmsTaskOptimistic">
        SELECT * FROM sms_task_crond 
        WHERE status = 0 
        AND is_deleted = 0
        ORDER BY create_time ASC
    </select>
    
    <!-- 根据ID查询任务 -->
    <select id="findById" parameterType="java.math.BigInteger" resultType="com.example.module.entity.SmsTaskOptimistic">
        SELECT * FROM sms_task_crond WHERE id = #{id} AND is_deleted = 0
    </select>
    
    <!-- 根据手机号查询任务 -->
    <select id="findByPhone" parameterType="string" resultType="com.example.module.entity.SmsTaskOptimistic">
        SELECT * FROM sms_task_crond WHERE phone = #{phone} AND is_deleted = 0 ORDER BY create_time DESC
    </select>
    
    <!-- 尝试锁定任务 -->
    <update id="tryLockTask">
        UPDATE sms_task_crond 
        <set>
            status = 100,
            <if test="updateTime != null">update_time = #{updateTime},</if>
        </set>
        WHERE id = #{id} AND status = 0 AND is_deleted = 0
    </update>
    
</mapper>